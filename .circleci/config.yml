version: 2.1

orbs:
  node: circleci/node@4.1

jobs:
  install_dependencies:
    docker:
      - image: node:18
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "package.json" }}
      - run: npm install
      - run: npm run frontend:install
      - run: npm run backend:install
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - ./node_modules
            - ./store/store-frontend/node_modules
            - ./store/store-backend/node_modules

  build_frontend:
    docker:
      - image: node:18
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-frontend-{{ checksum "store/store-frontend/package.json" }}
      - run:
          name: Clean previous artifacts
          command: rm -rf store/store-frontend/dist
      - run:
          name: Create dist Folder
          command: mkdir -p store/store-frontend/dist
      - run:
          name: Check dist folder contents
          command: ls -la store/store-frontend/dist
      - run:
          name: Build Frontend
          command: cd store/store-frontend && npm run build
      - run:
          name: Diagnose
          command: |
            ls -la
            ls -la store
            ls -la store/store-frontend
            ls -la store/store-frontend/dist
      - persist_to_workspace:
          root: .
          paths:
            - store/store-frontend/dist

  deploy_frontend:
    docker:
      - image: node:18
    environment:
      AWS_DEFAULT_REGION: us-east-1
    steps:
      - checkout
      - attach_workspace:
          at: .

      - restore_cache:
          key: dependency-cache-frontend-{{ checksum "store/store-frontend/package.json" }}
      - run:
          name: Install AWS CLI
          command: |
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            ./aws/install
      - run:
          name: Deploy to S3
          command: |
            ls -la store/store-frontend/dist

workflows:
  version: 2
  build_and_test:
    jobs:
      - install_dependencies
      - build_frontend:
          requires:
            - install_dependencies
      - deploy_frontend:
          requires:
            - build_frontend
